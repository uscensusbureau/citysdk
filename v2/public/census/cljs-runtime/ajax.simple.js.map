{"version":3,"sources":["ajax/simple.cljc"],"sourcesContent":["(ns ajax.simple\n    (:require [clojure.string :as str]\n              [ajax.protocols :as pr]\n              [ajax.interceptors :as i]\n              [ajax.formats :as f]\n              [ajax.util :as u]\n              #? (:clj [ajax.apache :as a])\n              #? (:clj [poppea :as p]\n                  :cljs [goog.net.XhrIo :as xhr]))\n    #? (:clj (:import [java.io Closeable])\n        :cljs (:require-macros [poppea :as p])))\n\n(defn normalize-method [method]\n  (if (keyword? method)\n    (str/upper-case (name method))\n    method))\n\n(defn process-response [response interceptor]\n  (pr/-process-response interceptor response))\n\n(p/defn-curried js-handler [handler interceptors response]\n  (let [processed (reduce process-response response interceptors)]\n    ;;; This requires a bit of explanation: if we return a closeable,\n    ;;; it should be wrapping the original response, so we _don't_\n    ;;; close the original response stream\n    ;;; If you're writing a weird interceptor that doesn't do this,\n    ;;; remember to close the original stream yourself\n    #? (:clj (if (and response\n                      (instance? Closeable (second processed)))\n               (.close ^Closeable (pr/-body response))))\n    (handler processed)))\n\n(defn base-handler [interceptors {:keys [handler]}]\n  (if handler\n    (js-handler handler interceptors)\n    (u/throw-error \"No ajax handler provided.\")))\n\n(def default-interceptors (atom []))\n\n(defn normalize-request [request]\n  (let [response-format (i/get-response-format f/detect-response-format request)]\n    (-> request\n        (update :method normalize-method)\n        (update :interceptors\n                #(concat [response-format]\n                         (or % @default-interceptors)\n                         i/request-interceptors)))))\n\n(defn new-default-api []\n  #? (:clj  (a/new-api)\n      :cljs (new goog.net.XhrIo)))\n\n(defn process-request [request interceptor]\n  \"-process-request with the arguments flipped for use in reduce\"\n  (pr/-process-request interceptor request))\n\n(defn raw-ajax-request [{:keys [interceptors] :as request}]\n  \"The main request function.\"\n  (let [request (reduce process-request request interceptors)\n        ;;; Pass the request through the interceptors\n        handler (base-handler (reverse interceptors) request)\n        ;;; Set up a handler that passes it back through\n        api (or (:api request) (new-default-api))]\n    (pr/-js-ajax-request api request handler)))\n\n(defn ajax-request [request]\n  (-> request normalize-request raw-ajax-request))\n"],"mappings":";;;;;;;;AAYA,AAAA,AAAMA,AAAkB;AAAxB,AACE,AAAI,AAAAC,AAAUC;AACZ,AAACC,AAAe,AAACC,AAAKF;;AACtBA;;;AAEJ,AAAA,AAAMG,AAAkB,AAAS;AAAjC,AACE,AAACC,AAAqBC,AAAYC;;AAEpC,AAAA,AAAA,AAAA,AAAgBE;AAAhB,AAAA,AAAA,AAAA,AAAA;AAAA,AAAA,AAAAD;AAAA;AAAA,AAAAC,AAAA,AAAA,AAAA,AAAA,AAAA,AAAA,AAAA,AAAA,AAAA;;;AAAA;AAAA,AAAAA,AAAA,AAAA,AAAA,AAAA,AAAA,AAAA;;;AAAA;AAAA,AAAAA,AAAA,AAAA,AAAA;;;;AAAA,AAAA,AAAAC,AAAA,AAAA,AAAA,AAAA;;;;;AAAA,AAAA,AAAA,AAAgBD,AAAY,AAAQ,AAAa;AAAjD,AACE,AAAM,AAAU,AAACE,AAAOP,AAAiBG,AAASK;AAAlD,AASE,AAACC,AAAAA,AAAAA,AAAQC,AAAAA;;;AAVb,AAAA,AAAA,AAAgBL,AAAY,AAAQ;AAApC,AAAA,AAAiD;AAAjD,AACE,AAAM,AAAU,AAACE,AAAOP,AAAiBG,AAASK;AAAlD,AASE,AAACC,AAAAA,AAAAA,AAAQC,AAAAA;;;;AAVb,AAAA,AAAA,AAAgBL,AAAY;AAA5B,AAAA,AAAoC,AAAa;AAAjD,AACE,AAAM,AAAU,AAACE,AAAOP,AAAiBG,AAASK;AAAlD,AASE,AAACC,AAAAA,AAAAA,AAAQC,AAAAA;;;;AAVb,AAAA,AAAA,AAAgBL;;AAAhB,AAYA,AAAA,AAAA,AAAMY,AAAc;AAApB,AAAA,AAAA,AAAAN;AAAA,AAAA,AAAA,AAAA,AAAA,AAAAC,AAAA,AAAA,AAAA,AAAA,AAAA,AAAAA,AAAA,AAAA,AAAAC,AAAA,AAAAD,AAAA,AAAA,AAAA,AAAA,AAAAE,AAAAC,AAAAH,AAAAA;AAAA,AAAAI,AAAAJ,AAAA,AAAyC;AAAzC,AACE,AAAIH;AACF,AAACS,AAAWT,AAAQD;;AACpB,AAAA,AAACW;;;AAEL,AAAKC,AAAqB,AAAA,AAACC;AAE3B,AAAA,AAAMC,AAAmB;AAAzB,AACE,AAAM,AAAgB,AAACC,AAAsBC,AAAyBC;AAAtE,AACMA,AACA,AAAA,AAACC,AAAe/B,AAChB,AAAA,AAAA,AAAC+B;AAAD;AAAA,AACS,AAAA,AAACC,AAAQC,AACD,AAAA,AAAAC;AAAA,AAAA,AAAAC;AAAAA;;AAAA,AAAAC,AAAOX;;AACPY;;;;AAEzB,AAAA,AAAMC;AAAN,AAEY,AAAKC;;AAEjB,AAAA,AAAMC,AAAiB,AAAQ;AAA/B,AAAA;AAEE,AAACC,AAAoBlC,AAAYuB;;AAEnC,AAAA,AAAA,AAAMc;AAAN,AAAA,AAAA,AAAAF;AAAA,AAAA,AAAA,AAAA,AAAA,AAAAC,AAAA,AAAA,AAAA,AAAA,AAAA,AAAAA,AAAA,AAAA,AAAAzB,AAAA,AAAAyB,AAAA,AAAA,AAAA,AAAA,AAAAxB,AAAAC,AAAAuB,AAAAA;AAAAA,AAAkD;AAAlD,AAAAtB,AAAAsB,AAAA,AAAgC;AAAhC,AAAA;AAEE,AAAM,AAAQ,AAAC/B,AAAO4B,AAAgBV,AAAQjB;AAExC,AAAQ,AAACS,AAAa,AAACuB,AAAQhC,AAAciB;AAE7C,AAAI,AAAA,AAAI,AAAA,AAAMA;AAAV,AAAA,AAAAK;AAAAA;;AAAmB,AAACG;;;AAJ9B,AAKE,AAACQ,AAAoBC,AAAIjB,AAAQhB;;AAErC,AAAA,AAAMkC,AAAc;AAApB,AACE,AAAA,AAAIlB,AAAQH,AAAkBiB","names":["ajax.simple/normalize-method","cljs.core/Keyword","method","clojure.string/upper-case","cljs.core/name","ajax.simple/process-response","ajax.protocols/-process-response","interceptor","response","G__8918","ajax.simple/js-handler","js/Error","cljs.core.reduce.cljs$core$IFn$_invoke$arity$3","interceptors","handler","processed","p__8923","map__8924","cljs.core/PROTOCOL_SENTINEL","cljs.core.apply.cljs$core$IFn$_invoke$arity$2","cljs.core/hash-map","cljs.core.get.cljs$core$IFn$_invoke$arity$2","ajax.simple/base-handler","ajax.simple.js_handler.cljs$core$IFn$_invoke$arity$2","ajax.util/throw-error","ajax.simple/default-interceptors","cljs.core.atom.cljs$core$IFn$_invoke$arity$1","ajax.simple/normalize-request","ajax.interceptors/get-response-format","ajax.formats/detect-response-format","request","cljs.core.update.cljs$core$IFn$_invoke$arity$3","cljs.core.concat.cljs$core$IFn$_invoke$arity$variadic","response-format","p1__8927#","or__4047__auto__","cljs.core/deref","ajax.interceptors/request-interceptors","ajax.simple/new-default-api","goog.net/XhrIo","ajax.simple/process-request","ajax.protocols/-process-request","p__8929","map__8930","ajax.simple/raw-ajax-request","cljs.core/reverse","ajax.protocols/-js-ajax-request","api","ajax.simple/ajax-request"]}