{"version":3,"file":"shadow.cljs.devtools.client.env.js","sources":["shadow/cljs/devtools/client/env.cljs"],"mappings":"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","names":["js/shadow","js/shadow.cljs","js/shadow.cljs.devtools","js/shadow.cljs.devtools.client","js/shadow.cljs.devtools.client.env","js/shadow.cljs.devtools.client.env.runtime-id","shadow.cljs.devtools.client.env/runtime-id","cljs.core/random-uuid","goog/define","shadow.cljs.devtools.client.env/get-server-host","and__3938__auto__","shadow.cljs.devtools.client.env/use-document-host","js/goog.global.document","js/goog.global.document.location","cljs.core/seq","js/goog.global.document.location.hostname","js/document.location.hostname","shadow.cljs.devtools.client.env/server-host","shadow.cljs.devtools.client.env/get-url-base","shadow.cljs.devtools.client.env/devtools-url","shadow.cljs.devtools.client.env/ssl","shadow.cljs.devtools.client.env/server-port","shadow.cljs.devtools.client.env/get-ws-url-base","clojure.string/replace","js/Error","shadow.cljs.devtools.client.env/ws-url","runtime-type","cljs.core/Keyword","shadow.cljs.devtools.client.env/build-id","shadow.cljs.devtools.client.env/proc-id","cljs.core/name","shadow.cljs.devtools.client.env/ws-listener-url","client-type","shadow.cljs.devtools.client.env/files-url","shadow.cljs.devtools.client.env/repl-print-fn","shadow.cljs.devtools.client.env/repl-pprint","cljs.core/pr-str","obj","sb__4462__auto__","goog.string/StringBuffer","*print-newline*30006","cljs.core/*print-newline*","*print-fn*30007","cljs.core/*print-fn*","x__4463__auto__","cljs.pprint.pprint.cljs$core$IFn$_invoke$arity$1","shadow.cljs.devtools.client.env/repl-error","e","G__30010","cljs.core.assoc.cljs$core$IFn$_invoke$arity$3","shadow.cljs.devtools.client.env/repl-call","repl-expr","repl-error","e30011","result","ret","cljs.core/*3","cljs.core/*2","cljs.core/*1","e30012","js/console.log","cljs.core/*e","js/shadow.cljs.devtools.client.env.reset-print-fn-ref","shadow.cljs.devtools.client.env/reset-print-fn-ref","cljs.core.atom.cljs$core$IFn$_invoke$arity$1","shadow.cljs.devtools.client.env/set-print-fns!","msg-fn","original-print-fn","original-print-err-fn","cljs.core/*print-err-fn*","cljs.core/reset!","cljs.core/set-print-fn!","cljs.core/set-print-err-fn!","args","G__30013","clojure.string.join.cljs$core$IFn$_invoke$arity$2","cljs.core.apply.cljs$core$IFn$_invoke$arity$2","G__30014","shadow.cljs.devtools.client.env/reset-print-fns!","temp__5457__auto__","cljs.core/deref","x","shadow.cljs.devtools.client.env/process-ws-msg","text","handler","*default-data-reader-fn*30021","cljs.tools.reader/*default-data-reader-fn*","tag","value","e30022","msg","cljs.tools.reader.read_string.cljs$core$IFn$_invoke$arity$1","js/console.warn","p__30023","p__30024","map__30025","cljs.core/PROTOCOL_SENTINEL","cljs.core/hash-map","cljs.core.get.cljs$core$IFn$_invoke$arity$2","map__30026","shadow.cljs.devtools.client.env/make-task-fn","log-missing-fn","log-call-async","log-call","fn-sym","fn-str","async","next","e30029","fn-obj","js/goog.getObjectByName","js/$CLJS","ex","p__30030","vec__30031","seq__30032","first__30033","cljs.core/first","cljs.core/next","shadow.cljs.devtools.client.env/do-js-reload*","failure-fn","task","remaining-tasks","e30034","G__30035","var_args","G__30039","shadow.cljs.devtools.client.env/do-js-reload","p__30040","map__30041","load-code-fn","shadow.cljs.devtools.client.env.do_js_reload.cljs$core$IFn$_invoke$arity$3","complete-fn","shadow.cljs.devtools.client.env.do_js_reload.cljs$core$IFn$_invoke$arity$4","error","remaining","reload-info","load-tasks","cljs.core.into.cljs$core$IFn$_invoke$arity$2","p1__30036#","cljs.core.map.cljs$core$IFn$_invoke$arity$2","cljs.core/reverse","cljs.core.conj.cljs$core$IFn$_invoke$arity$2","cljs.core.into.cljs$core$IFn$_invoke$arity$3","p1__30037#","cljs.core.map.cljs$core$IFn$_invoke$arity$1","p__30044","map__30045","shadow.cljs.devtools.client.env/before-load-src","type","ns","src","cljs.core._EQ_.cljs$core$IFn$_invoke$arity$2","seq__30047","chunk__30048","count__30049","i__30050","cljs.core/chunked-seq?","c__4351__auto__","cljs.core/chunk-first","cljs.core/chunk-rest","cljs.core/count","js/goog.global.SHADOW_NS_RESET"],"sourcesContent":["(ns shadow.cljs.devtools.client.env\n  (:require\n    [goog.object :as gobj]\n    [clojure.string :as str]\n    [cljs.tools.reader :as reader]\n    [cljs.pprint :refer (pprint)]\n    ))\n\n;; FIXME: make this persistent somehow?\n(defonce runtime-id (random-uuid))\n\n(goog-define enabled false)\n\n(goog-define autoload true)\n\n(goog-define module-format \"goog\")\n\n(goog-define reload-with-state false)\n\n(goog-define build-id \"\")\n\n(goog-define proc-id \"\")\n\n(goog-define server-host \"\")\n\n(goog-define server-port 8200)\n\n(goog-define repl-pprint false)\n\n(goog-define use-document-host true)\n\n(goog-define devtools-url \"\")\n\n(goog-define ssl false)\n\n(goog-define ignore-warnings false)\n\n(defn get-server-host []\n  (cond\n    (and use-document-host\n         js/goog.global.document\n         js/goog.global.document.location\n         (seq js/goog.global.document.location.hostname))\n    js/document.location.hostname\n\n    (seq server-host)\n    server-host\n\n    :else\n    \"localhost\"))\n\n(defn get-url-base []\n  (if (seq devtools-url)\n    devtools-url\n    (str \"http\" (when ssl \"s\") \"://\" (get-server-host) \":\" server-port)))\n\n(defn get-ws-url-base []\n  (-> (get-url-base)\n      (str/replace #\"^http\" \"ws\")))\n\n(defn ws-url [runtime-type]\n  {:pre [(keyword? runtime-type)]}\n  (str (get-ws-url-base) \"/ws/worker/\" build-id \"/\" proc-id \"/\" runtime-id \"/\" (name runtime-type)))\n\n(defn ws-listener-url [client-type]\n  (str (get-ws-url-base) \"/ws/listener/\" build-id \"/\" proc-id \"/\" runtime-id))\n\n(defn files-url []\n  (str (get-url-base) \"/worker/files/\" build-id \"/\" proc-id \"/\" runtime-id))\n\n(def repl-print-fn\n  (if-not repl-pprint\n    pr-str\n    (fn repl-pprint [obj]\n      (with-out-str\n        (pprint obj)\n        ))))\n\n(defn repl-error [e]\n  (-> {:type :repl/invoke-error\n       ;; FIXME: may contain non-printable things and would break the client read\n       ;; :ex-data (ex-data e)\n       :error (.-message e)}\n      (cond->\n        (.hasOwnProperty e \"stack\")\n        (assoc :stack (.-stack e)))))\n\n(defn repl-call [repl-expr repl-error]\n  (try\n    (let [result {:type :repl/result}\n          ret (repl-expr)]\n      (set! *3 *2)\n      (set! *2 *1)\n      (set! *1 ret)\n\n      (try\n\n        (assoc result\n          :value (repl-print-fn ret))\n        (catch :default e\n          (js/console.log \"encoding of result failed\" e ret)\n          (assoc result :error \"ENCODING FAILED\"))))\n    (catch :default e\n      (set! *e e)\n      (repl-error e)\n      )))\n\n;; FIXME: this need to become idempotent somehow\n;; but is something sets a print-fn we can't tell if that\n;; will actually call ours. only a problem if the websocket is\n;; reconnected though\n(defonce reset-print-fn-ref (atom nil))\n\n(defn set-print-fns! [msg-fn]\n  ;; cannot capture these before as they may change in between loading this file\n  ;; and running the websocket connect. the user code is loaded after this file\n  (let [original-print-fn cljs.core/*print-fn*\n        original-print-err-fn cljs.core/*print-err-fn*]\n\n    (reset! reset-print-fn-ref\n      (fn reset-print-fns! []\n        (set-print-fn! original-print-fn)\n        (set-print-err-fn! original-print-err-fn)))\n\n    (set-print-fn!\n      (fn repl-print-fn [& args]\n        (msg-fn {:type :repl/out :text (str/join \"\" args)})\n        (when original-print-fn\n          (apply original-print-fn args))))\n\n    (set-print-err-fn!\n      (fn repl-print-err-fn [& args]\n        (msg-fn {:type :repl/err :text (str/join \"\" args)})\n        (when original-print-err-fn\n          (apply original-print-err-fn args))))))\n\n(defn reset-print-fns! []\n  (when-let [x @reset-print-fn-ref]\n    (x)\n    (reset! reset-print-fn-ref nil)))\n\n(defn process-ws-msg [text handler]\n  (binding [reader/*default-data-reader-fn*\n            (fn [tag value]\n              [:tagged-literal tag value])]\n    (try\n      (let [msg (reader/read-string text)]\n        (handler msg))\n      (catch :default e\n        (js/console.warn \"failed to parse websocket message\" text e)\n        (throw e)))))\n\n(defn make-task-fn [{:keys [log-missing-fn log-call-async log-call]} {:keys [fn-sym fn-str async]}]\n  (fn [next]\n    (try\n      (let [fn-obj (js/goog.getObjectByName fn-str js/$CLJS)]\n        (cond\n          (nil? fn-obj)\n          (do (when log-missing-fn\n                (log-missing-fn fn-sym))\n              (next))\n\n          async\n          (do (when log-call-async\n                (log-call-async fn-sym))\n              (fn-obj next))\n\n          :else\n          (do (when log-call\n                (log-call fn-sym))\n              (fn-obj)\n              (next))))\n      (catch :default ex\n        (js/console.warn \"error when calling lifecycle function\" (str fn-sym) ex)\n        (next)))))\n\n(defn do-js-reload* [failure-fn [task & remaining-tasks]]\n  (when task\n    (try\n      (task #(do-js-reload* failure-fn remaining-tasks))\n      (catch :default e\n        (failure-fn e task remaining-tasks)))))\n\n(defn do-js-reload\n  \"should pass the :build-complete message and an additional callback\n   which performs the actual loading of the code (sync)\n   will call all before/after callbacks in order\"\n  ([msg load-code-fn]\n   (do-js-reload\n     msg\n     load-code-fn\n     (fn [])))\n  ([msg load-code-fn complete-fn]\n   (do-js-reload\n     msg\n     load-code-fn\n     complete-fn\n     (fn [error task remaining]\n       (js/console.warn \"JS reload failed\" error))))\n  ([{:keys [reload-info] :as msg} load-code-fn complete-fn failure-fn]\n   (let [load-tasks\n         (-> []\n             ;; unload is FILO\n             (into (->> (:before-load reload-info)\n                        (map #(make-task-fn msg %))\n                        (reverse)))\n             (conj (fn [next]\n                     (load-code-fn)\n                     (next)))\n             ;; load is FIFO\n             (into (map #(make-task-fn msg %)) (:after-load reload-info))\n             (conj (fn [next]\n                     (complete-fn)\n                     (next))))]\n\n     (do-js-reload* failure-fn load-tasks))))\n\n(defn before-load-src [{:keys [type ns] :as src}]\n  (when (= :cljs type)\n    (doseq [x js/goog.global.SHADOW_NS_RESET]\n      (x ns))))\n"]}