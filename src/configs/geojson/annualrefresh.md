# WGET

---

# Note: do this at your own risk. If too eager, Census will blacklist your IP address.

---

## Changes

-   Aug 31, 2022: Moved `index.edn` config file from `src/configs/geojson` to `GeoJSON` directory

## Prerequisits:

-   Install [Chocolately (Windows)](https://chocolatey.org/install)
-   Install [wget](): `choco install wget --version 1.20`

### Step 1: Downloading Shape Files

1. Create a folder into which the files will be downloaded
2. Within the folder (`cd <folder name>`):

To get a recursive search through folders (branches) and assets (leaves) in a subdomain:
`wget -r -np -R "index.html*" -e robots=off https://www2.census.gov/geo/tiger/PREVGENZ/`

```shell script
# latest
wget -r -np -R "index.html*" -e robots=off https://www2.census.gov/geo/tiger/GENZ2022/shp/
```

To remove a specific subdomain, use the `-X` (exclusion) option:
`wget -r -np -R "index.html*" -e robots=off -X /geo/tiger/GENZ2021/kml/,other/path/to/exclude/ https://www2.census.gov/geo/tiger/GENZ2021/`

#### Components

-   `wget` (from where it was downloaded)
-   `-r` (recursive)
-   `-np` (no parent)
-   `-R "index.html*"` (reject autogenerated index.html files)
-   `-e robots=off` (allow parsing despite blocked robots/crawlers file)
-   `-X /geo/tiger/GENZ2015/kml/,other/path/exclude/` notice in the example above that we don't include the host server in the exclusion path
-   `https://www2.census.gov/geo/tiger/GENZ2021/shp/` make sure to add the trailing `/` to let wget know that this is a directory and not a file

### Step 2: Making a List of Local File Paths for Conversion

Create a vector (array) of filenames to use for conversion.

-   for [windows](https://superuser.com/questions/379499/list-files-with-path-using-windows-command-line)

1.  Navigate into the folder where all the downloaded files reside
2.  in `cmd`:

```
dir/s/b * > paths_full.txt
```

3. Convert the lines in the text file to a vector (array) of strings (each line surrounded by `"",`)

### Step 3: Batch Conversion (`./core.cljs`) of Shapefiles to GeoJSON

[comment]: <> (- [cljs-promises.async :refer [value-port]] -> moved to local dep)
[comment]: <> (Note that you should not update [mkdirp]&#40;https://github.com/isaacs/node-mkdirp/issues/3&#41; as the latest version changes the API from a callback to a promise and I'm just too lazy to update the code as such -> I ended up updating this)

> # Deprecated: Moved to S3 (no filesize limit)
> ### Step 4: Post Processing Using [mapshaper](https://mapshaper.org/)
> 
> > Note: There is a limit to the filesize that Github will accept (at time of writing <100mb). For files larger than this, some post-processing will be needed
> 
> Upload the larger files to mapshaper and use the Douglas Pueker algorithm to reduce the filesize (it's an iterative process)
> 
> ### Step 5: `git push...` the newly minted GeoJSON files
> 
> Make sure the ZCTAs will fit... then...

`git subtree pull --prefix=v2 census-geojson master`
`git push origin master`

### Step 6: Remove dependencies in _Step 3_ and `git push ...`

## Syncing local GeoJSON files to S3 (also relieves 100mb Github file size limit)

You can get your current AWS User ID in the CLI by:

```shell
aws sts get-caller-identity --query "Account" --output text
```

1. First, go to the AWS IAM Console and set an AWS IAM Policy with the appropriate access
    - Service: `S3`
    - Actions:
        - `List > ListBucket`
        - `Write > PutObject`
        - `Write > DeleteObject`
        - `Read > GetObject`
    - Resources: Bucket name: `census-geojson`, Object name: check "Any" box
2. Create a IAM User and assign it the Policy
    - "Add User"
    - User name: "census-geojson-user"
    - Access type: "Access key - Programmatic Access"
    - Attach existing policy: search and select `census-geojson`
3. Add profile of current user to your profiles

```shell
Î» aws configure --profile census-geojson
AWS Access Key ID [None]: <Access Key ID from AWS IAM Console>
AWS Secret Access Key [None]: <Secret from AWS IAM Console>
Default region name [None]: us-east-1
Default output format [None]: json
```

4. Change default user to `census-geojson` user (You have to restart your terminal after doing this for it to take effect)

```shell
# Linux and MacOS
export AWS_PROFILE=<profile-name>

# Windows Command Prompt
setx AWS_PROFILE <profile-name>

# PowerShell
$Env:AWS_PROFILE="<profile-name>"
```

Once you've restarted your terminal, you can confirm that you've changed your default AWS CLI Profile by:

```shell
aws configure list
```

You can view all of your AWS CLI Profiles by opening:

```shell
# on Linux and macOS
~/.aws/credentials

# on Windows
C:\Users\<USERNAME>\.aws\credentials
```

The bucket policy for `census-geojson` bucket is this:

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Principal": "*",
            "Action": "s3:GetObject",
            "Resource": "arn:aws:s3:::census-geojson/*"
        },
        {
            "Sid": "Stmt1546414471931",
            "Effect": "Allow",
            "Principal": {
                "AWS": "arn:aws:iam::538069693173:user/census-geojson-user"
            },
            "Action": "s3:ListBucket",
            "Resource": "arn:aws:s3:::census-geojson"
        }
    ]
}
```

The `ListBucket` setting is an alias for the `ListObjectV2` API call, which is [needed to run the `sync` command](https://aws.amazon.com/premiumsupport/knowledge-center/s3-access-denied-listobjects-sync/)

5. In your terminal, navigate to the root directory of this repo
6. From within that directory, open your shell and `sync` the local directory to the bucket:

```shell
aws s3 sync <local directory> s3://<your/bucket>
```

In this case (from root of project)

```shell
aws s3 sync ./GeoJSON s3://census-geojson --size-only
```
(`--size-only`: only uploads new files)