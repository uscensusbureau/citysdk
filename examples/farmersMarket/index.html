---
layout: exampleslayout
published: true
title: CitySDK - Farmer's Market Search
---


<div class="row">
    <div class="col-md-12">


        <div class="panel panel-info">
            <div class="panel-heading">
                <h3 class="panel-title">1. Select Location</h3>
            </div>
            <div class="panel-body">
                <div class="row">
                    <div class="col-md-4">
                        <label>Specify Location By</label><br/>
                        <input type="radio" name="location_radios" id="specify_location_coords" value="location_coords"
                               onclick="visible('location_coords')" checked> <label for="specify_location_coords">Coordinates</label><br/>
                        <input type="radio" name="location_radios" id="specify_location_zip" value="location_zip"
                               onclick="visible('location_zip')"> <label for="specify_location_zip">Zip
                        Code</label><br/>
                        <!--<input type="radio" name="location_radios" id="specify_location_state" value="location_state"
                               onclick="visible('location_state')"> <label for="specify_location_state">State
                        Code</label><br/>
                        <input type="radio" name="location_radios" id="specify_location_address"
                               value="location_address" onclick="visible('location_address')"> <label
                            for="specify_location_address">Address</label>-->
                    </div><!-- end col-md-4 -->

                    <div class="col-md-8">


                        <div class="location_coords">
                            <label for="lat">Latitude:</label>

                            <div class="input-group">
                                <input type="text" class="form-control reqparam" id="lat" placeholder=""
                                       aria-describedby="lat-helpblock">
                                <span class="input-group-addon" id="basic-addon2">&deg;N</span>
                            </div>
                            <span id="lat-helpblock" class="help-block">Number - The latitude of the requested location (North). Also supported: latitude, y</span>
                            <label for="lng">Longitude:</label>

                            <div class="input-group">
                                <input type="text" class="form-control reqparam" id="lng" placeholder=""
                                       aria-describedby="lng-helpblock">
                                <span class="input-group-addon" id="basic-addon3">&deg;E</span>
                            </div>
                            <span id="lng-helpblock" class="help-block">Number - The longitude of the requested location (East). Also supported: longitude, x</span>
                        </div><!-- end location_coords -->


                        <div class="location_zip">
                            <label>Zip Code:</label>
                            <input class="reqparam form-control" id="zip" type="text" size="5"
                                   aria-describedby="zip-helpblock"/>

                            <span id="zip-helpblock" class="help-block">String - The 5-digit zip code of the location. Note that USPS zip code areas do not
                                align precisely with Census geographies, so when high accuracy is required it is
                                recommended to use latitude and longitude. Specified as a string because certain zip
                                codes begin with zeroes.</span>

                        </div><!-- end location_zip -->


                        <div class="location_state">
                            <label for="state">State:</label>
                            <select class="reqparam form-control" id='state'>
                                <option value=""></option>
                            </select>

                            <p>String - The 2-letter USPS state code. It will be converted into the latitude and
                                longitude of that state's capital.</p>

                        </div><!-- end location_state -->


                        <div class="location_address">
                            <label for="address_street">Street:</label>
                            <input class="reqparam form-control" id="address_street" type="text"/>
                            <label for="address_city">City:</label>
                            <input class="reqparam form-control" id="address_city" type="text"/>
                            <label for="address_state">State:</label>
                            <input class="reqparam form-control" id="address_state" type="text"/>

                            <p><em>Object - Represents the address of the requested location.</em></p>
                        </div><!-- end location_address -->


                    </div>
                </div>
            </div>
            {% include coordsTable.html %}

        </div>

        <div class="panel panel-info">
            <div class="panel-heading">
                <h3 class="panel-title">2. Submit</h3>
            </div>
            <div class="panel-body">

                <div class="col-md-6">
                    &nbsp;
                </div><!-- end col-md-6 -->

                <div class="col-md-6">
                    <h4>Get the Data</h4>

                    <p><input id="submitFindFarmersMarket" type="button" value="Update data"
                              class="btn btn-lg btn-primary" style="width: 100%;"></p>


                    <div class="loading-icon loading-icon-initialstate"></div>

                </div>


            </div>
        </div>


        <div class="panel panel-success">
            <div class="panel-heading">
                <div class="pull-right"><a id="saveLink" class="btn btn-primary btn-xs disabled" href="#" role="button">Save
                    Variables to CSV File</a></div>

                <h3 class="panel-title">The Returned Data</h3>

            </div>
            <div class="panel-body">

                <div class="loading-icon loading-icon-initialstate"></div>


                <div class="outputSet">

                    <!-- Nav tabs -->
                    <ul class="nav nav-tabs" role="tablist">
                        <li role="presentation" class="active mapControlTab">
                            <a href="#formateedOutput" aria-controls="formateedOutput" role="tab" data-toggle="tab">Formatted
                                Results</a>
                        </li>
                        <li role="presentation" class="rawOutputControlTab"><a href="#unformattedOutput"
                                                                               aria-controls="unformattedOutput"
                                                                               role="tab" data-toggle="tab">Raw JSON
                            Response</a></li>
                        <li role="presentation"><a href="#shortCodeExample" aria-controls="shortCodeExample" role="tab"
                                                   data-toggle="tab">Sample Code</a></li>

                    </ul>

                    <!-- Tab panes -->
                    <div class="tab-content">
                        <div role="tabpanel" class="mapControlTab tab-pane fade in active" id="formateedOutput">
                            <div class="row farmersMarketOutput" style="min-height:500px;width:100%;">
                                <div class="col-md-6" id="output"></div>
                                <div class="col-md-6" id="details"></div>
                            </div>
                        </div>
                        <div role="tabpanel" class="tab-pane rawOutputControlTab" id="unformattedOutput">
                            <p>
                            <pre id="rawOutput"></pre>
                            </p>

                        </div>
                        <div role="tabpanel" class="tab-pane" id="shortCodeExample">
                            <pre id="shortCodeExampleAPIRequest"><code>&lt;script&gt;

                                var <var>sdk</var> = new CitySDK();
                                var <var>farmersMarkets</var> = sdk.modules.farmersMarket;

                                var <var>request</var> = <span class="machineRequestPlaceholder">{}</span>;

                                farmersMarkets.APIRequest(request, function (<var>response</var>) {
                                jQuery(&quot;#rawOutput&quot;).text(JSON.stringify(<var>response</var>));
                                jQuery(&#39;#output&#39;).empty();

                                if (response.results[0][&#39;id&#39;] != &quot;Error&quot;) {

                                jQuery(&#39;#output&#39;).append(&quot;&lt;table&gt;&lt;tr&gt;&lt;th&gt;Market&lt;/th&gt;&lt;th&gt;Details&lt;/th&gt;&lt;/tr&gt;&lt;tbody&gt;&lt;/tbody&gt;&lt;/table&gt;&quot;);
                                for (var i = 0; i &lt; response.results.length; i++) {
                                jQuery(&#39;#output table tbody&#39;).append(&quot;&lt;tr&gt;&lt;td&gt;&quot; +
                                response.results[i].marketname + &#39;&lt;/td&gt;&lt;td class=&quot;centeredCellButton
                                details-link&quot;&gt;&lt;input type=&quot;submit&quot; class=&quot;btn btn-xs
                                btn-primary&quot; value=&quot;View Details&quot; onclick=&quot;details(&#39; +
                                response.results[i].id + &#39;,\&#39;&#39; +
                                String(response.results[i].marketname).replace(/([&#39;&quot;])/g, &quot;\\$1&quot;) +
                                &#39;\&#39;)&quot;&gt;&lt;/td&gt;&lt;/tr&gt;&#39;);
                                }

                                } else {

                                jQuery(&#39;#output&#39;).append(&#39;&lt;br/&gt;&lt;div class=&quot;alert alert-warning&quot;
                                role=&quot;alert&quot;&gt;&lt;strong&gt;No Data.&lt;/strong&gt; There are no farmers
                                markets matching the requested location.&lt;/div&gt;&#39;);

                                }
                                });
                                &lt;/script&gt;</code></pre>


                        </div>
                    </div>

                </div>


            </div>
        </div>


    </div>
</div>

<script>
    var sdk = new CitySDK();
    var farmersMarkets = sdk.modules.farmersMarket;

    jQuery(document).ready(function () {
        visible("location_coords");
        jQuery("#submitFindFarmersMarket").click(submitFindFarmersMarket);

        jQuery("#saveLink").click(function (e) {
            e.preventDefault();

            var csvString;
            csvString = convertOutput();
            saveToCSVfile(csvString);

        });

    });

    function loadCoords(lat, lng) {
        $("#lat").val(lat);
        $("#lng").val(lng);
    }

    function submitFindFarmersMarket() {
        jQuery(".loading-icon-initialstate").show();
        jQuery(".outputSet").hide();


        $('#details').empty();

        var lat = $("#lat").val();
        var lng = $("#lng").val();
        var zip = $("#zip").val();

        var request = {};

        if (jQuery('input[name=location_radios]:radio:checked').val() == "location_zip") {
            request.zip = zip;
        } else {
            request.lat = lat;
            request.lng = lng;
        }

        jQuery(".machineRequestPlaceholder").text(JSON.stringify(request));

        farmersMarkets.APIRequest(request, function (response) {
            jQuery("#rawOutput").text(JSON.stringify(response));
            jQuery('#output').empty();
            if (response.results[0]['id'] != "Error") {
                jQuery('#output').append("<table><tr><th>Market</th><th>Details</th></tr><tbody></tbody></table>");
                for (var i = 0; i < response.results.length; i++) {
                    jQuery('#output table tbody').append("<tr><td>" + response.results[i].marketname + '</td><td class="centeredCellButton details-link"><input type="submit" class="btn btn-xs btn-primary" value="View Details" onclick="details(' + response.results[i].id + ',\'' + String(response.results[i].marketname).replace(/(['"])/g, "\\$1") + '\')"></td></tr>');
                }
            } else {
                jQuery('#output').append('<br/><div class="alert alert-warning" role="alert"><strong>No Data.</strong> There are no farmers markets matching the requested location.</div>');
            }

            jQuery(".loading-icon").hide();
            jQuery(".outputSet").show();
            jQuery('#saveLink').removeClass('disabled');

        });
    }

    function details(id, name) {
        farmersMarkets.detail({"id": id}, function (response) {
            response = response.marketdetails;
            console.log(response);
            var details = $('#details');
            details.empty();
            details.append('<h3>' + name + '</h3>');
            details.append("<h4>Schedule</h4><p>" + response.Schedule + "</p>");
            details.append('<h4>Location <a class="btn btn-xs btn-info" target="_blank" href="' + response.GoogleLink + '">(Google Map)</a></h4><address>' + response.Address + "</address>");
            details.append('');
            details.append("<h4>Products</h4><p>" + response.Products + "</p>");
        });
    }

    function convertOutput() {
        var textarea = jQuery('#rawOutput').text();
        console.log(textarea);
        var JSONObject = JSON.parse(textarea);
        console.log(JSONObject);
        var csvString = "";
        var keys;
        for (var index in JSONObject.results) {
            if (index == 0) {
                keys = Object.keys(JSONObject.results[index]);
                for (var key in keys) {
                    csvString = csvString + keys[key];
                    if (key != (keys.length - 1)) {
                        csvString = csvString + ',';
                    } else {
                        csvString = csvString + '\n';
                    }
                }
            }
            for (var key in keys) {
                var dataJSONObject = JSONObject.results[index];
                csvString = csvString + dataJSONObject[keys[key]];
                if (key != (keys.length - 1)) {
                    csvString = csvString + ',';
                } else {
                    csvString = csvString + '\n';
                }
            }
        }
        console.log(csvString);
        return csvString;
    }

    function visible(x) {
        var tabs = jQuery("*[class^='" + x.split("_")[0] + "']");
        tabs.each(function (f) {
            jQuery(this).hide();
        });
        jQuery('.' + x).show();
    }


</script>
